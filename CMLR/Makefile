CXXFLAGS := -std=c++17 -O0 -Wall -Wextra -Wpedantic -g -fPIC
ifneq ($(shell which clang++ 2> /dev/null),)
	CXX := clang++
	CXXFLAGS += -Weverything -Wno-c++98-compat -Wno-padded -Wno-shadow
else
	CXX := g++
endif

Boost_DIR := /usr

CPPFLAGS := \
	-isystem $(shell python3 -c 'import sysconfig; print(sysconfig.get_config_var("INCLUDEPY"))') \
	-I$(Boost_DIR)/include \
	-isystem ../Code \
	-I../Code/GraphMol/FileParsers \
	-isystem ../build/Code \
	-isystem ../build/_deps/catch2-src/src/catch2/.. \
	-isystem ../build/_deps/catch2-build/generated-includes \

LDFLAGS := \
	-L$(Boost_DIR)/lib -Wl,-rpath=$(Boost_DIR)/lib \
	-L../build/lib '-Wl,-rpath=$$ORIGIN/../build/lib' \
	-L../build/Code/RDGeneral \
	-L../build/_deps/catch2-build/src \

LDLIBS := \
	-lrdkitCatch \
	-lCatch2d \
	-lRDKitFileParsers \
	-lRDKitGraphMol \
	-lRDKitRDGeometryLib \
	-lRDKitRDGeneral \
	-lboost_python$(shell python3 -c 'import sysconfig; print(sysconfig.get_config_var("py_version_nodot"))') \
	$(shell python3 -c 'import sysconfig; print(sysconfig.get_config_var("BLDLIBRARY"))') \
	-lpthread \
	-Wl,--as-needed

CMAKE_CXX_CLANG_TIDY := clang-tidy --fix --header-filter=! \
	--checks=bugprone-*,clang-*,misc-*,-misc-non-private-member-variables-in-classes,-misc-unused-parameters,modernize-*,-modernize-use-trailing-return-type,readbility-*

.PHONY: all
all: a.out file_parsers_catch.out rdmolfiles.so
a.out: main.o CMLReader.o
	$(MAKE) dep
	$(CXX) -o $@ $^ $(LDFLAGS) $(LDLIBS)

file_parsers_catch.out: file_parsers_catch.o CMLReader.o
	$(MAKE) dep
	$(CXX) -o $@ $^ $(LDFLAGS) $(LDLIBS)

rdmolfiles.so: rdmolfiles.o CMLReader.o
	$(MAKE) dep
	$(CXX) -shared -fPIC -o $@ $^ $(LDFLAGS) $(LDLIBS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -o $@ -c $^

.PHONY: dep
dep:
	cmake --build ../build -j 1 -- librdkitCatch.a libRDKitGraphMol.so

.PHONY: clang-format
clang-format:
	clang-format -i $(shell realpath CMLReader.cpp)

.PHONY: clang-tidy
clang-tidy: $(patsubst %.cpp,%.tidy,CMLReader.cpp file_parsers_catch.cpp main.cpp rdmolfiles.cpp)

%.tidy: %.cpp
	$(CMAKE_CXX_CLANG_TIDY) $(shell realpath $^) -- $(CXX) $(CXXFLAGS) $(CPPFLAGS) -c $(shell realpath $^)
	touch $@

.PHONY: clean
clean:
	echo *.so *.o *.out *.tidy | xargs rm -f
